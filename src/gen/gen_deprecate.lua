local output_file = arg[1]
local deprecated_txt = arg[2]
local f1 = assert(io.open(output_file, 'w'), ('failed to open: %s'):format(output_file))

local content = {
  '-- This file is generated by script',
  '',
  'local deprecated = {',
}

local f2 = assert(io.open(deprecated_txt, 'r'), ('failed to open: %s'):format(deprecated_txt))

local tags = {
  ['LSP DIAGNOSTICS'] = true,
  ['LUA'] = true,
  ['TREESITTER'] = true,
  ['LSP'] = true,
  ['DIAGNOSTICS'] = true,
  ['API'] = true,
}

local seen = {}
local current_section = nil

for line in f2:lines() do
  local trimmed = line:match('^%s*(.-)%s*$')
  if tags[trimmed] then
    current_section = trimmed
  end

  if current_section and tags[current_section] then
    for name in line:gmatch('â€¢%s*%*?([nvim][%w%.%:_]-)%([^%)]-%)%*?') do
      if (name:match('^vim%.') or name:match('^nvim_')) and not seen[name] then
        seen[name] = true
        if current_section == 'API' then
          name = 'vim.api.' .. name
        end
        content[#content + 1] = ("  ['%s'] = true,"):format(name)
      end
    end
  end
end

f2:close()

content[#content + 1] = '}\n'
content[#content + 1] = 'return deprecated\n'
f1:write(table.concat(content, '\n'))
f1:close()
