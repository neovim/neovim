name: docs
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - '.github/workflows/docs.yml'
      - 'src/nvim/api/*.[ch]'
      - 'src/nvim/eval.lua'
      - 'runtime/lua/**.lua'
      - 'runtime/doc/**'
      - 'scripts/gen_vimdoc.py'
      - 'scripts/gen_help_html.lua'
jobs:
  docs:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: write
      pull-requests: write
    env:
      BIN_DIR: ${{ github.workspace }}/bin
      DOXYGEN_URL: 'https://github.com/doxygen/doxygen/releases/download/Release_1_9_5/doxygen-1.9.5.linux.bin.tar.gz'
      DOXYGEN_VERSION: 1.9.5
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Install dependencies
        run: |
          sudo apt-get install -y python3-msgpack

      - name: Install doxygen
        run: |
          curl --retry 5 --silent --show-error --fail -L -o /tmp/doxygen.tar.gz "$DOXYGEN_URL"
          mkdir -p "$BIN_DIR" /opt/doxygen
          tar xfz /tmp/doxygen.tar.gz --strip-components=1 -C /opt/doxygen
          ln -sfn /opt/doxygen/bin/doxygen "$BIN_DIR/doxygen"
          doxygen_version="$(doxygen -v)"
          echo "$doxygen_version" | grep -qF "$DOXYGEN_VERSION" || {
            echo "Unexpected doxygen version: $doxygen_version";
            exit 1;
          }

      - name: Generate docs
        run: |
          make doc
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Job failed, run 'make doc' and commit your doc changes."
            echo "::error::The doc generation produces the following changes:"
            git diff --color --exit-code
          fi

      - name: Validate docs
        run: make lintdoc
