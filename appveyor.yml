version: '{build}'
environment:
  APPVEYOR_CACHE_ENTRY_ZIP_ARGS: "-t7z -m0=lzma -mx=9"
  DEPS_BUILD_DIR: "C:/projects/nvim-deps"
  DEPS_PREFIX: "C:/projects/nvim-deps/usr"
  # Silence/redirect errors due to missing locking support (via libgcov).
  GCOV_ERROR_FILE: "$(TEMP)/libgcov-errors.log"

  # TEST: for LuaRocks with MSVC?!
  VCINSTALLDIR: "C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/"
image: Visual Studio 2017
configuration:
- MSVC_32
- MINGW_64
init: []
# RDP
#- ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
matrix:
  fast_finish: true
install: []
before_build:
- ps: Install-Product node 10
build_script:
- powershell ci\build.ps1
after_build:
- ps: |
    if (Test-Path $env:GCOV_ERROR_FILE) {
      Get-Content $env:GCOV_ERROR_FILE -Head 10
      Get-Content $env:GCOV_ERROR_FILE -Tail 10
    } else {
      write-host "no GCOV_ERROR_FILE"
    }
# DEBUG: should have SYSTEM=windows
- ps: |
    Get-Content C:/projects/nvim-deps/usr/luarocks/lua/luarocks/core/hardcoded.lua
    Get-Content C:/projects/nvim-deps/usr/luarocks/config-5.1.lua
cache:
- C:\projects\nvim-deps -> third-party\**
artifacts:
- path: build/Neovim.zip
- path: build/bin/nvim.exe
